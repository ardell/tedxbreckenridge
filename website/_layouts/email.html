---
---
{%- comment -%}
Email layout - provides preview with merge tags substituted,
plus source view for copying to Mailchimp.
{%- endcomment -%}

{%- capture raw_content -%}{{ content }}{%- endcapture -%}

{%- comment -%} Substitute Mailchimp merge tags for preview {%- endcomment -%}
{%- assign preview_content = raw_content -%}

{%- comment -%} Handle the greeting conditional: *|IF:FNAME|*Hi *|FNAME|*,*|ELSE:|*Hi there,*|END:IF|* {%- endcomment -%}
{%- capture fname_conditional -%}*|IF:FNAME|*Hi *|FNAME|*,*|ELSE:|*Hi there,*|END:IF|*{%- endcapture -%}
{%- capture fname_replacement -%}Hi {{ site.data.email_preview.FNAME }},{%- endcapture -%}
{%- assign preview_content = preview_content | replace: fname_conditional, fname_replacement -%}

{%- comment -%} Handle the LIST conditional - just show the content {%- endcomment -%}
{%- assign preview_content = preview_content | replace: '*|IF:LIST|*', '' -%}
{%- assign preview_content = preview_content | replace: '*|END:IF|*', '' -%}

{%- comment -%} Substitute standard merge tags {%- endcomment -%}
{%- assign preview_content = preview_content | replace: '*|FNAME|*', site.data.email_preview.FNAME -%}
{%- assign preview_content = preview_content | replace: '*|LNAME|*', site.data.email_preview.LNAME -%}
{%- assign preview_content = preview_content | replace: '*|EMAIL|*', site.data.email_preview.EMAIL -%}
{%- assign preview_content = preview_content | replace: '*|UNSUB|*', site.data.email_preview.UNSUB -%}
{%- assign preview_content = preview_content | replace: '*|UPDATE_PROFILE|*', site.data.email_preview.UPDATE_PROFILE -%}
{%- assign preview_content = preview_content | replace: '*|ARCHIVE|*', site.data.email_preview.ARCHIVE -%}
{%- assign preview_content = preview_content | replace: '*|FORWARD|*', site.data.email_preview.FORWARD -%}
{%- assign preview_content = preview_content | replace: '*|LIST:NAME|*', site.data.email_preview.LIST_NAME -%}
{%- assign preview_content = preview_content | replace: '*|LIST:COMPANY|*', site.data.email_preview.LIST_COMPANY -%}
{%- assign preview_content = preview_content | replace: '*|LIST:URL|*', site.data.email_preview.LIST_URL -%}
{%- assign preview_content = preview_content | replace: '*|LIST:ADDRESS|*', site.data.email_preview.LIST_ADDRESS -%}
{%- assign preview_content = preview_content | replace: '*|MC:SUBJECT|*', site.data.email_preview.MC_SUBJECT -%}
{%- assign preview_content = preview_content | replace: '*|CURRENT_YEAR|*', site.data.email_preview.CURRENT_YEAR -%}

{%- comment -%} Preview-only content: substitute in preview, strip from source {%- endcomment -%}
{%- assign preview_content = preview_content | replace: '*|PREVIEW_PREHEADER|*', site.data.email_preview.PREVIEW_PREHEADER -%}
{%- assign preview_content = preview_content | replace: '*|PREVIEW_BODY|*', site.data.email_preview.PREVIEW_BODY -%}
{%- assign preview_content = preview_content | replace: '*|PREVIEW_CTA_URL|*', site.data.email_preview.PREVIEW_CTA_URL -%}
{%- assign preview_content = preview_content | replace: '*|PREVIEW_CTA_TEXT|*', site.data.email_preview.PREVIEW_CTA_TEXT -%}

{%- comment -%} Create source content: strip PREVIEW_* tags entirely {%- endcomment -%}
{%- assign source_content = raw_content | replace: '*|PREVIEW_PREHEADER|*', '' -%}
{%- assign source_content = source_content | replace: '*|PREVIEW_BODY|*', '' -%}
{%- assign source_content = source_content | replace: '*|PREVIEW_CTA_URL|*', 'YOUR_URL_HERE' -%}
{%- assign source_content = source_content | replace: '*|PREVIEW_CTA_TEXT|*', 'Your CTA Text' -%}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ page.title }} | Email Preview</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Core TED Brand */
      --ted-red: #e4291c;
      --ted-red-dark: #C70022;
      --black: #000;
      --white: #FFF;

      /* Evergreen Palette */
      --teal: #3F6F6F;
      --forest: #4A7470;
      --charcoal: #2A2A2A;
      --stone: #676767;
      --cream: #F9F7F4;
      --sand: #E8E6E3;
      --teal-light: #A3C4C4;

      /* Typography */
      --font-primary: 'Helvetica Neue', helvetica, inter, arial, sans-serif;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-primary);
      font-weight: 400;
      background: var(--cream);
      color: var(--black);
      line-height: 1.6;
    }

    /* Navigation */
    .nav {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      padding: 20px 48px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--white);
      box-shadow: 0 1px 0 rgb(0 0 0 / 8%);
    }

    .nav-logo {
      display: flex;
      align-items: center;
      line-height: 0;
      text-decoration: none;
    }

    .nav-logo img {
      height: 40px;
      width: auto;
      display: block;
      vertical-align: middle;
      position: relative;
      top: 2px;
    }

    .nav-actions {
      display: flex;
      align-items: center;
      gap: 24px;
    }

    .nav-link {
      font-size: 13px;
      font-weight: 400;
      color: var(--stone);
      text-decoration: none;
      transition: color 0.2s ease;
    }

    .nav-link:hover {
      color: var(--teal);
    }

    .nav-btn {
      font-family: var(--font-primary);
      font-size: 13px;
      font-weight: 500;
      padding: 12px 24px;
      background: var(--ted-red);
      color: var(--white);
      text-decoration: none;
      border: none;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .nav-btn:hover {
      background: var(--ted-red-dark);
    }

    /* Dropdown */
    .nav-dropdown {
      position: relative;
      display: flex;
    }

    .nav-dropdown .nav-btn:first-child {
      border-radius: 0;
    }

    .nav-dropdown-toggle {
      padding: 12px 10px;
      border-left: 1px solid rgb(255 255 255 / 20%);
      border-radius: 0;
    }

    .nav-dropdown-menu {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 4px;
      background: var(--white);
      box-shadow: 0 4px 12px rgb(0 0 0 / 15%);
      min-width: 140px;
      z-index: 200;
    }

    .nav-dropdown-menu.open {
      display: block;
    }

    .nav-dropdown-menu a {
      display: block;
      padding: 12px 16px;
      font-size: 13px;
      color: var(--charcoal);
      text-decoration: none;
      transition: background 0.15s ease;
    }

    .nav-dropdown-menu a:hover {
      background: var(--cream);
    }

    /* Main Content */
    main {
      padding-top: 100px;
      padding-bottom: 60px;
    }

    /* Email Preview Frame */
    .email-frame {
      max-width: 700px;
      margin: 0 auto;
      background: var(--white);
      box-shadow: 0 4px 24px rgb(0 0 0 / 8%);
    }

    .email-frame.hidden {
      display: none;
    }

    /* Source View */
    .source-view {
      display: none;
      max-width: 900px;
      margin: 0 auto;
      background: var(--white);
      box-shadow: 0 4px 24px rgb(0 0 0 / 8%);
      padding: 48px;
    }

    .source-view.active {
      display: block;
    }

    .source-header {
      margin-bottom: 32px;
      padding-bottom: 24px;
      border-bottom: 1px solid var(--sand);
    }

    .source-header h2 {
      font-size: 24px;
      font-weight: 300;
      color: var(--black);
      margin-bottom: 8px;
    }

    .source-header p {
      font-size: 15px;
      color: var(--stone);
    }

    .source-subject {
      margin-bottom: 24px;
      padding: 20px 24px;
      background: var(--cream);
      border-left: 3px solid var(--ted-red);
    }

    .source-subject-label {
      font-size: 11px;
      font-weight: 500;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--stone);
      margin-bottom: 4px;
    }

    .source-subject-value {
      font-size: 15px;
      color: var(--black);
    }

    .source-actions {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 24px;
    }

    .btn {
      font-family: var(--font-primary);
      font-size: 13px;
      font-weight: 500;
      padding: 12px 24px;
      background: var(--ted-red);
      color: var(--white);
      text-decoration: none;
      border: none;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .btn:hover {
      background: var(--ted-red-dark);
    }

    .copied {
      font-size: 13px;
      color: var(--forest);
      font-weight: 500;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .copied.show {
      opacity: 1;
    }

    textarea {
      width: 100%;
      height: calc(100vh - 400px);
      min-height: 400px;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 12px;
      line-height: 1.6;
      padding: 24px;
      border: 1px solid var(--sand);
      background: var(--cream);
      color: var(--charcoal);
      resize: vertical;
    }

    textarea:focus {
      outline: none;
      border-color: var(--teal);
    }

    /* Raw mode - shows just the email without wrapper */
    body.raw-mode {
      background: none;
    }

    body.raw-mode .nav,
    body.raw-mode .source-view,
    body.raw-mode .nav-dropdown-menu {
      display: none !important;
    }

    body.raw-mode main {
      padding: 0;
    }

    body.raw-mode .email-frame {
      max-width: none;
      margin: 0;
      box-shadow: none;
    }

    /* Mobile */
    @media (max-width: 768px) {
      .nav {
        padding: 16px 24px;
      }

      .nav-logo img {
        height: 32px;
      }

      .nav-actions {
        gap: 16px;
      }

      .nav-link {
        display: none;
      }

      main {
        padding-top: 80px;
        padding-bottom: 40px;
      }

      .email-frame {
        margin: 0 16px;
      }

      .source-view {
        margin: 0 16px;
        padding: 24px;
      }

      .source-header h2 {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <nav class="nav">
    <a href="/" class="nav-logo">
      <img src="/assets/images/logos/tedx-breckenridge-logo-black.png" alt="TEDxBreckenridge">
    </a>
    <div class="nav-actions">
      <a href="/emails/" class="nav-link">← All Emails</a>
      <div class="nav-dropdown">
        <button class="nav-btn" id="toggleBtn" onclick="toggleView()">View Source</button>
        <button class="nav-btn nav-dropdown-toggle" onclick="toggleDropdown(event)" aria-label="More options">▾</button>
        <div class="nav-dropdown-menu" id="dropdownMenu">
          <a href="?raw" target="_blank">View Raw</a>
        </div>
      </div>
    </div>
  </nav>

  <main>
    <!-- Preview View -->
    <div class="email-frame" id="previewView">
      {{ preview_content }}
    </div>

    <!-- Source View -->
    <div class="source-view" id="sourceView">
      <div class="source-header">
        <h2>HTML Source</h2>
        <p>Copy and paste into Mailchimp's code editor</p>
      </div>

      {% if page.subject %}
      <div class="source-subject">
        <div class="source-subject-label">Recommended Subject</div>
        <div class="source-subject-value">{{ page.subject }}</div>
      </div>
      {% endif %}

      <div class="source-actions">
        <button class="btn" onclick="copySource()">Copy HTML</button>
        <span class="copied" id="copied">Copied to clipboard</span>
      </div>

      <textarea id="source" readonly>{{ source_content | strip | xml_escape }}</textarea>
    </div>
  </main>

  <script>
    // Check for raw mode
    if (window.location.search.includes('raw')) {
      document.body.classList.add('raw-mode');
    }

    function toggleDropdown(e) {
      e.stopPropagation();
      const menu = document.getElementById('dropdownMenu');
      menu.classList.toggle('open');
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function() {
      const menu = document.getElementById('dropdownMenu');
      menu.classList.remove('open');
    });

    function toggleView() {
      const preview = document.getElementById('previewView');
      const source = document.getElementById('sourceView');
      const btn = document.getElementById('toggleBtn');

      if (source.classList.contains('active')) {
        source.classList.remove('active');
        preview.classList.remove('hidden');
        btn.textContent = 'View Source';
      } else {
        source.classList.add('active');
        preview.classList.add('hidden');
        btn.textContent = 'View Preview';
      }
    }

    function copySource() {
      const textarea = document.getElementById('source');
      textarea.select();
      textarea.setSelectionRange(0, 99999);
      navigator.clipboard.writeText(textarea.value).then(() => {
        const copied = document.getElementById('copied');
        copied.classList.add('show');
        setTimeout(() => copied.classList.remove('show'), 2000);
      });
    }
  </script>
</body>
</html>
